---
import Layout from '../layouts/Layout.astro';
import EmojiGrid from '../components/EmojiGrid.tsx';
import SearchBar from '../components/SearchBar';
import { EmojiExport } from '../components/EmojiExport';
import type { EmojiMetadata } from '../types/emoji';
import emojiMetadata from '../data/emoji-metadata.json';

// Get unique categories
const categories = Array.from(new Set(emojiMetadata.emojis.flatMap(emoji => emoji.categories))).filter(Boolean);
---

<Layout title="Emoji Explorer">
  <div class="container mx-auto px-4 py-8 space-y-8">
    <section class="text-center">
      <h2 class="text-3xl font-bold tracking-tight">Welcome to Emoji Explorer</h2>
      <p class="mt-4 text-muted-foreground">
        Browse, search, and explore our collection of emojis
      </p>
    </section>

    <div class="max-w-5xl mx-auto">
      <SearchBar
        client:load
        categories={categories}
        onSearch={(query: string) => {
          document.dispatchEvent(new CustomEvent('search', { detail: query }));
        }}
        onCategorySelect={(category: string) => {
          document.dispatchEvent(new CustomEvent('categorySelect', { detail: category }));
        }}
        recentEmojis={[]}
      />
    </div>
    
    <section class="max-w-7xl mx-auto">
      <EmojiGrid
        client:load
        emojis={emojiMetadata.emojis}
        onSelectionChange={(selectedEmojis) => {
          document.dispatchEvent(new CustomEvent('updateSelectedEmojis', { detail: selectedEmojis }));
        }}
      />
    </section>
    
    <EmojiExport
      client:load
      selectedEmojis={[]}
      onClearSelection={() => { 
        document.dispatchEvent(new CustomEvent('clearSelection'));
      }}
    />
  </div>

  <script define:vars={{ initialEmojis: emojiMetadata.emojis }}>
    // Initialize state
    let currentEmojis = initialEmojis;
    let selectedCategory = 'all';
    let searchQuery = '';
    let selectedEmojis = [];
    let recentEmojis = JSON.parse(localStorage.getItem('recentEmojis') || '[]');

    function filterEmojis() {
      let filtered = initialEmojis;

      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(emoji => 
          emoji.filename.toLowerCase().includes(query) ||
          emoji.tags.some(tag => tag.toLowerCase().includes(query)) ||
          emoji.categories.some(category => category.toLowerCase().includes(query))
        );
      }

      if (selectedCategory !== 'all') {
        filtered = filtered.filter(emoji =>
          emoji.categories.includes(selectedCategory)
        );
      }

      return filtered;
    }

    // Handle search
    document.addEventListener('search', (e) => {
      searchQuery = e.detail;
      const filteredEmojis = filterEmojis();
      document.dispatchEvent(new CustomEvent('updateEmojis', { detail: filteredEmojis }));
    });

    // Handle category selection
    document.addEventListener('categorySelect', (e) => {
      selectedCategory = e.detail;
      const filteredEmojis = filterEmojis();
      document.dispatchEvent(new CustomEvent('updateEmojis', { detail: filteredEmojis }));
    });

    // Handle clear selection
    document.addEventListener('clearSelection', () => {
      document.dispatchEvent(new CustomEvent('clearEmojiSelection'));
    });

    // Handle selection updates
    document.addEventListener('updateSelectedEmojis', (e) => {
      // Update recent emojis if a single emoji was selected
      selectedEmojis = e.detail;
      if (e.detail && e.detail.length > 0) {
        recentEmojis = [e.detail[0], ...recentEmojis.filter(emoji => emoji.id !== e.detail[0].id)].slice(0, 8);
        localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
        document.dispatchEvent(new CustomEvent('updateRecentEmojis', { detail: recentEmojis }));
      }
      // Update EmojiExport component
      document.dispatchEvent(new CustomEvent('updateExportEmojis', { detail: selectedEmojis }));
    });

    // Initialize components with default state
    document.dispatchEvent(new CustomEvent('updateEmojis', { detail: currentEmojis }));
    document.dispatchEvent(new CustomEvent('updateRecentEmojis', { detail: recentEmojis }));
  </script>
</Layout>
